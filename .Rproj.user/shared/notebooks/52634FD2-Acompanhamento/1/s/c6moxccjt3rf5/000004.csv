"0","## api for update data of Covid19 cases"
"0","read_CityDataCovid <- function() {"
"0","  # read api url for update  "
"0","  url <- ""https://brasil.io/api/dataset/covid19/caso/data?format=json"""
"0","  tf <- GET(url)"
"0","  "
"0","  content <- httr::content(tf, as = 'text')"
"0","  content_from_json <- jsonlite::fromJSON(content)"
"0","  out<- content_from_json$results"
"0","  # verify more pages of data and get all"
"0","  while(!is.null(content_from_json$`next`)){"
"0","    url <- content_from_json$`next`"
"0","    tf <- GET(url)"
"0","    content <- httr::content(tf, as = 'text')"
"0","    content_from_json <- jsonlite::fromJSON(content)"
"0","    results_df_np<- content_from_json$results"
"0","    out <- bind_rows(out, results_df_np)"
"0","  }"
"0","    return(out)"
"0","}"
"0","# get data"
"0","data <- read_CityDataCovid()"
"0","data$date <- as.Date(data$date)"
"0","data$new_cases <- rep(NA, nrow(data))"
"0","data_SC_state <- data %>% filter(state == ""SC""  & place_type == ""state"")%>% arrange(date) %>% mutate(day=1+(row_number()-1)*7,ease=""linear"") "
"0","data <- data %>% filter(state == ""SC""  & place_type == ""city"", !is.na(city_ibge_code))"
"0","# get the new cases per city in each day "
"0","city_ibge_code <- unique(data$city_ibge_code)"
"0","new_cases <- data.frame()"
"0","for (i in 1:length(city_ibge_code)) {"
"0","  city_data <- data %>% filter(city_ibge_code == city_ibge_code[i]) %>% arrange(date)"
"0","  date <- city_data %>% select(date) %>% distinct()"
"0","  city_data$new_cases[1] <- city_data$confirmed[1]"
"0","  if(nrow(city_data) > 1){"
"0","    for (k in 2:nrow(city_data)) {"
"0","      city_data$new_cases[k] <- city_data$confirmed[k] - city_data$confirmed[k-1]"
"0","      }"
"0","  }"
"0","  new_cases <- bind_rows(new_cases, city_data)"
"0","}"
"0","data <- new_cases"
"0","rm(city_ibge_code, new_cases, date)"
"0",""
"0",""
"0","# lat/lng data of cities"
"0","cidade_latlng <- read.csv(""municipios_latlng.csv"")"
"0","cidade_latlng <- cidade_latlng %>% select(codigo_ibge = 1, lat = latitude, lng = longitude)"
"0","cidade_latlng$codigo_ibge <- as.character(cidade_latlng$codigo_ibge)"
"0","data <- left_join(data, cidade_latlng, by = c(""city_ibge_code"" = ""codigo_ibge""))"
"0","data_SC_state <- left_join(data_SC_state, cidade_latlng, by = c(""city_ibge_code"" = ""codigo_ibge""))"
"0","last_data <- data %>% filter(is_last == T)"
"0",""
"0","# geometry data of cities"
"0","shp_sf <- get_brmap(""City"", geo.filter = list(State = 42))"
"0","shp_sf$City <- as.character(shp_sf$City)"
"0","shp_sf <- st_as_sf(shp_sf)%>%"
"0"," st_transform(4326)"
"0","shp_sf <- shp_sf %>% filter(City %in% last_data$city_ibge_code)"
"0","shp_sf_last_data <- left_join(shp_sf,last_data, by = c(""City"" = ""city_ibge_code""))"
"0","shp_sf <- left_join(shp_sf,data, by = c(""City"" = ""city_ibge_code""))"
"0",""
